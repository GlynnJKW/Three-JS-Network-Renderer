<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8>
		<title>My first three.js app</title>
		<style>
			body { margin: 0; }
			canvas { width: 100%; height: 100% }
		</style>
	</head>
	<body>

		<script type="x-shader/x-vertex" id="sphereVert">
			varying vec2 fraguv;

			uniform vec2 screen;
			uniform float radius;

			varying vec4 test;


			float trueDepth(float d){
				float zn = 0.1;
				float zf = 1000.0;

				float d_e = 2.0 * zn * zf / (zf + zn - d * (zf - zn));
				return d_e;
			}

			float fakeDepth(float d){
				float A = projectionMatrix[2].z;
				float B = projectionMatrix[3].z;
				return 0.5 * (-A*d + B) / d + 0.5;
			}

			void main(){
				vec4 clipPos = projectionMatrix * (modelViewMatrix * vec4( position, 1.0 ) + vec4(0,0,0.1,0));
				vec2 size = vec2(radius) / screen.xy;
				float screenz = (clipPos.z/clipPos.w + 1.0)/2.0;
				
				float zfactor = (1.0 - pow(screenz, 0.5)) * 100.0 + 0.01;

				size *= zfactor;

				fraguv = uv;//* 2.0 - vec2(1.0,1.0);


				vec4 fragpos = clipPos + vec4((clipPos.ww * fraguv.xy) * size, 0, 0);

				gl_Position = fragpos;
				test.rgb = color;
			}

		</script>
		<script type="x-shader/x-fragment" id="sphereFrag">
			
			varying vec2 fraguv;
			varying vec4 test;

			void main(){
				float rad = fraguv.x * fraguv.x + fraguv.y * fraguv.y;
				if(rad > 1.0){
					discard;
				}
				gl_FragColor = vec4(test.rgb * pow((1.0 - rad), 0.5), 1);
			}
		</script>
		<script type="x-shader/x-vertex" id="pickingSphereVert">
			varying vec2 fraguv;
			varying vec3 id;

			attribute vec3 colorid;

			uniform vec2 screen;
			uniform float radius;

			void main(){
				vec4 clipPos = projectionMatrix * (modelViewMatrix * vec4( position, 1.0 ) + vec4(0,0,0.1,0));
				vec2 size = vec2(radius) / screen.xy;
				float screenz = (clipPos.z/clipPos.w + 1.0)/2.0;
				
				float zfactor = (1.0 - pow(screenz, 0.5)) * 100.0 + 0.01;

				size *= zfactor;

				fraguv = uv;//* 2.0 - vec2(1.0,1.0);

				id = colorid;

				vec4 fragpos = clipPos + vec4((clipPos.ww * fraguv.xy) * size, 0, 0);

				gl_Position = fragpos;
			}

		</script>
		<script type="x-shader/x-fragment" id="pickingSphereFrag">
			
			varying vec2 fraguv;
			varying vec3 id;

			void main(){
				float rad = fraguv.x * fraguv.x + fraguv.y * fraguv.y;
				if(rad > 1.0){
					discard;
				}
				gl_FragColor = vec4(id, 1);
			}
		</script>
		<script type="x-shader/x-vertex" id="lineVert">

			uniform vec3 color0;
			uniform vec3 color1;
			uniform vec2 screen;

			attribute float intensity;
			attribute vec3 direction;

			varying vec4 col;
			varying float y;

			highp mat3 transpose(in highp mat3 inMatrix) {
				highp vec3 i0 = inMatrix[0];
				highp vec3 i1 = inMatrix[1];
				highp vec3 i2 = inMatrix[2];
			
				highp mat3 outMatrix = mat3(
							 vec3(i0.x, i1.x, i2.x),
							 vec3(i0.y, i1.y, i2.y),
							 vec3(i0.z, i1.z, i2.z)
							 );
			
				return outMatrix;
			}

			void main(){
				float alpha = sqrt(abs(0.5 - intensity) * 2.0);
				vec3 albedo;
				if(intensity > 0.5){
					albedo = color1 * alpha;
				}
				else{
					albedo = color0 * alpha;
				}
				col = vec4(albedo, alpha);


				vec3 worldPos = (modelMatrix * vec4(position, 1.0)).xyz;

				vec3 viewDir = normalize(worldPos - cameraPosition);
				vec3 d = normalize(modelMatrix * vec4(direction, 0.0)).xyz;
				vec3 u = normalize(cross(d, viewDir));

				worldPos += u * uv.y * 0.1;

				vec4 fragpos = projectionMatrix * viewMatrix * vec4(worldPos, 1.0);

				y = uv.y;

				gl_Position = fragpos;
			}
		</script>
		<script type="x-shader/x-fragment" id="lineFrag">
			
			varying vec4 col;
			varying float y;

			void main(){
				float rad = y * y;
				if(rad > 0.5){
					discard;
				}
				gl_FragColor = vec4(col.rgb * pow(1.0 - rad*2.0, 0.5), col.a);
			}
		</script>

        <script src="scripts/three.min.js"></script>
        <script src="scripts/jquery.min.js"></script>
		<script src="scripts/dat.gui.min.js"></script>
		<script src="dist/test6.bundle.js"></script>
	</body>
</html>